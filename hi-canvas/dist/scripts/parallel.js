!function(){function t(t,e){e||(e={});for(var n in t)void 0===e[n]&&(e[n]=t[n]);return e}function e(){this._callbacks=[],this._errCallbacks=[],this._resolved=0,this._result=null}function n(n,r){this.data=n,this.options=t(u,r),this.operation=new e,this.operation.resolve(null,this.data),this.requiredScripts=[],this.requiredFunctions=[]}var r="undefined"!=typeof module&&module.exports,o=!("undefined"!=typeof window&&this===window),s=s||function(t){setTimeout(t,0)},a=o?require(__dirname+"/Worker.js"):self.Worker,i="undefined"!=typeof self?self.URL?self.URL:self.webkitURL:null,l=!(!o&&!self.Worker);e.prototype.resolve=function(t,e){if(t){this._resolved=2,this._result=t;for(var n=0;n<this._errCallbacks.length;++n)this._errCallbacks[n](t)}else{this._resolved=1,this._result=e;for(var r=0;r<this._callbacks.length;++r)this._callbacks[r](e)}this._callbacks=[],this._errCallbacks=[]},e.prototype.then=function(t,e){return 1===this._resolved?void(t&&t(this._result)):2===this._resolved?void(e&&e(this._result)):(t&&(this._callbacks[this._callbacks.length]=t),e&&(this._errCallbacks[this._errCallbacks.length]=e),this)};var u={evalPath:o?__dirname+"/eval.js":null,maxWorkers:o?require("os").cpus().length:navigator.hardwareConcurrency||4,synchronous:!0,env:{},envNamespace:"env"};n.isSupported=function(){return l},n.prototype.getWorkerSource=function(t,e){var n="",r=0;for(o||0===this.requiredScripts.length||(n+='importScripts("'+this.requiredScripts.join('","')+'");\r\n'),r=0;r<this.requiredFunctions.length;++r)n+=this.requiredFunctions[r].name?"var "+this.requiredFunctions[r].name+" = "+this.requiredFunctions[r].fn.toString()+";":this.requiredFunctions[r].fn.toString();e=JSON.stringify(e||{});var s=this.options.envNamespace;return o?n+'process.on("message", function(e) {global.'+s+" = "+e+";process.send(JSON.stringify(("+t.toString()+")(JSON.parse(e).data)))})":n+"self.onmessage = function(e) {var global = {}; global."+s+" = "+e+";self.postMessage(("+t.toString()+")(e.data))}"},n.prototype.require=function(){for(var t,e=Array.prototype.slice.call(arguments,0),n=0;n<e.length;n++)t=e[n],"string"==typeof t?this.requiredScripts.push(t):"function"==typeof t?this.requiredFunctions.push({fn:t}):"object"==typeof t&&this.requiredFunctions.push(t);return this},n.prototype._spawnWorker=function(t,e){var n,r=this.getWorkerSource(t,e);if(o)n=new a(this.options.evalPath),n.postMessage(r);else{if(void 0===a)return;try{if(0!==this.requiredScripts.length){if(null===this.options.evalPath)throw new Error("Can't use required scripts without eval.js!");n=new a(this.options.evalPath),n.postMessage(r)}else{if(!i)throw new Error("Can't create a blob URL in this browser!");var s=new Blob([r],{type:"text/javascript"}),l=i.createObjectURL(s);n=new a(l)}}catch(u){if(null===this.options.evalPath)throw u;n=new a(this.options.evalPath),n.postMessage(r)}}return n},n.prototype.spawn=function(n,r){var o=this,a=new e;return r=t(this.options.env,r||{}),this.operation.then(function(){var t=o._spawnWorker(n,r);if(void 0!==t)t.onmessage=function(e){t.terminate(),o.data=e.data,a.resolve(null,o.data)},t.onerror=function(e){t.terminate(),a.resolve(e,null)},t.postMessage(o.data);else{if(!o.options.synchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");s(function(){try{o.data=n(o.data),a.resolve(null,o.data)}catch(t){a.resolve(t,null)}})}}),this.operation=a,this},n.prototype._spawnMapWorker=function(t,e,n,r,o){var a=this;if(o||(o=a._spawnWorker(e,r)),void 0!==o)o.onmessage=function(e){a.data[t]=e.data,n(null,o)},o.onerror=function(t){o.terminate(),n(t)},o.postMessage(a.data[t]);else{if(!a.options.synchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");s(function(){a.data[t]=e(a.data[t]),n()})}},n.prototype.map=function(n,r){function o(t,e){t?l.resolve(t,null):++i===s.data.length?(l.resolve(null,s.data),e&&e.terminate()):a<s.data.length?s._spawnMapWorker(a++,n,o,r,e):e&&e.terminate()}if(r=t(this.options.env,r||{}),!this.data.length)return this.spawn(n,r);var s=this,a=0,i=0,l=new e;return this.operation.then(function(){for(;a-i<s.options.maxWorkers&&a<s.data.length;++a)s._spawnMapWorker(a,n,o,r)},function(t){l.resolve(t,null)}),this.operation=l,this},n.prototype._spawnReduceWorker=function(t,e,n,r,o){var a=this;if(o||(o=a._spawnWorker(e,r)),void 0!==o)o.onmessage=function(t){a.data[a.data.length]=t.data,n(null,o)},o.onerror=function(t){o.terminate(),n(t,null)},o.postMessage(t);else{if(!a.options.synchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");s(function(){a.data[a.data.length]=e(t),n()})}},n.prototype.reduce=function(n,r){function o(t,e){--s,t?i.resolve(t,null):1===a.data.length&&0===s?(a.data=a.data[0],i.resolve(null,a.data),e&&e.terminate()):a.data.length>1?(++s,a._spawnReduceWorker([a.data[0],a.data[1]],n,o,r,e),a.data.splice(0,2)):e&&e.terminate()}if(r=t(this.options.env,r||{}),!this.data.length)throw new Error("Can't reduce non-array data");var s=0,a=this,i=new e;return this.operation.then(function(){if(1===a.data.length)i.resolve(null,a.data[0]);else{for(var t=0;t<a.options.maxWorkers&&t<Math.floor(a.data.length/2);++t)++s,a._spawnReduceWorker([a.data[2*t],a.data[2*t+1]],n,o,r);a.data.splice(0,2*t)}}),this.operation=i,this},n.prototype.then=function(t,n){var r=this,o=new e;return n="function"==typeof n?n:function(){},this.operation.then(function(){var e;try{t&&(e=t(r.data),void 0!==e&&(r.data=e)),o.resolve(null,r.data)}catch(s){n?(e=n(s),void 0!==e&&(r.data=e),o.resolve(null,r.data)):o.resolve(null,s)}},function(t){if(n){var e=n(t);void 0!==e&&(r.data=e),o.resolve(null,r.data)}else o.resolve(null,t)}),this.operation=o,this},r?module.exports=n:self.Parallel=n}();